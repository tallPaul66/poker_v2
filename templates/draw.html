<html>
  <style>
	body{ background-image:url("/static/card_pics/table_top_5.png");
		width: 100%;
	    height: 100%;
	    max-height: 100%;
		background-size:100% 100%;
		background-repeat: repeat;}
  </style>
  <head>
    <title>Draw Poker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="//code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf-8">
        // [Paul: trying this to fix constant disconnect error, from someone on stackexchange;
        // doesn't seem to help any]
            socket = io.connect(location.origin, {
                'timeout': 120000 // Increasing connection timeout.
            })
        $(document).ready(function() {
            // Use a "/test" namespace.
            // An application can open a connection on multiple namespaces, and
            // Socket.IO will multiplex all those connections on a single
            // physical channel. If you don't care about multiple channels, you
            // can set the namespace to an empty string.
            namespace = '/test';

            // Connect to the Socket.IO server.
            // The connection URL has the following format, relative to the current page:
            //     http[s]://<domain>:<port>[/<namespace>]
            var socket = io(namespace);

            // Event handler for new connections.
            // The callback function is invoked when a connection with the
            // server is established.
            socket.on('connect', function() {
                const url_params = new URLSearchParams(window.location.search);
                const player_name = url_params.get('player');
                socket.emit('my_event', {data: 'Client connected!', player: player_name});
            });
             
            /*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~            
                     Event handlers for server sent data.
            The callback function is invoked whenever the server emits data
            to the client.
            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */
             socket.on('join_msg', function(msg, cb) {
                // this doesnt append, just inserts a new msg, overwriting any previous text
                //$('#log').text('<br>' + $('<div/>').text('Received #' + msg.count + ': ' + msg.data).html());
                // but this appends....
                $('#log').append('<br>' + $('<div/>').text(msg.count + ' ' + msg.data).html());               
                if (cb)
                    cb();
            });
            
            socket.on('connect_msg', function(msg, cb) {                
                // but this appends....
                $('#log').append('<br>' + $('<div/>').text(msg.data + 
                    ', player: ' + msg.player + ', sid: ' + msg.sid).html());               
                if (cb)
                    cb();
            });
            socket.on('clear_msgs', function(msg, cb) {                
                // but this appends....
                $('#log').text($('<div/>').text('').html());
                if (cb)
                    cb();
            });
            socket.on('get_cards', function(msg, cb) {
                players_cards = msg.cards
                players = Object.keys(players_cards)
                console.log('keys are', players)
                console.log("player1's cards", players_cards.player1)
                
                if("player1" in players_cards){
                    var player1_card1 = players_cards.player1[0];
                    var player1_card2 = players_cards.player1[1];
                    var player1_card3 = players_cards.player1[2];
                    var player1_card4 = players_cards.player1[3];
                    var player1_card5 = players_cards.player1[4];
                    
                    document.getElementById('player1_card1').src = player1_card1;
                    document.getElementById('player1_card2').src = player1_card2;
                    document.getElementById('player1_card3').src = player1_card3;
                    document.getElementById('player1_card4').src = player1_card4;
                    document.getElementById('player1_card5').src = player1_card5;
                }
                
                if("player2" in players_cards){
                    var player2_card1 = players_cards.player2[0];
                    var player2_card2 = players_cards.player2[1];
                    var player2_card3 = players_cards.player2[2];
                    var player2_card4 = players_cards.player2[3];
                    var player2_card5 = players_cards.player2[4];
                    
                    document.getElementById('player2_card1').src = player2_card1;
                    document.getElementById('player2_card2').src = player2_card2;
                    document.getElementById('player2_card3').src = player2_card3;
                    document.getElementById('player2_card4').src = player2_card4;
                    document.getElementById('player2_card5').src = player2_card5;
                }
                if("player3" in players_cards){
                    var player3_card1 = players_cards.player3[0];
                    var player3_card2 = players_cards.player3[1];
                    var player3_card3 = players_cards.player3[2];
                    var player3_card4 = players_cards.player3[3];
                    var player3_card5 = players_cards.player3[4];
                    
                    document.getElementById('player3_card1').src = player3_card1;
                    document.getElementById('player3_card2').src = player3_card2;
                    document.getElementById('player3_card3').src = player3_card3;
                    document.getElementById('player3_card4').src = player3_card4;
                    document.getElementById('player3_card5').src = player3_card5;
                }
                
                if("player4" in players_cards){
                    var player4_card1 = players_cards.player4[0];
                    var player4_card2 = players_cards.player4[1];
                    var player4_card3 = players_cards.player4[2];
                    var player4_card4 = players_cards.player4[3];
                    var player4_card5 = players_cards.player4[4];
                    
                    document.getElementById('player4_card1').src = player4_card1;
                    document.getElementById('player4_card2').src = player4_card2;
                    document.getElementById('player4_card3').src = player4_card3;
                    document.getElementById('player4_card4').src = player4_card4;
                    document.getElementById('player4_card5').src = player4_card5;
                }
                
                if("player5" in players_cards){
                    var player5_card1 = players_cards.player5[0];
                    var player5_card2 = players_cards.player5[1];
                    var player5_card3 = players_cards.player5[2];
                    var player5_card4 = players_cards.player5[3];
                    var player5_card5 = players_cards.player5[4];
                
                    document.getElementById('player5_card1').src = player5_card1;
                    document.getElementById('player5_card2').src = player5_card2;
                    document.getElementById('player5_card3').src = player5_card3;
                    document.getElementById('player5_card4').src = player5_card4;
                    document.getElementById('player5_card5').src = player5_card5;
                }
                // below is from Miguel Grinberg's original code; I don't know what it does
                if (cb)
                    cb();
            });
            
            /*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~            
                     Handlers for the different forms in the page.
            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
            
            $('form#broadcast').submit(function(event) {
                socket.emit('my_broadcast_event', {data: $('#broadcast_data').val()});
                return false;
            });
            $('form#join').submit(function(event) {
                socket.emit('join', {room: $('#join_room').val()});
                return false;
            });
            $('form#leave').submit(function(event) {
                socket.emit('leave', {room: $('#leave_room').val()});
                return false;
            });
            $('form#deal').submit(function(event) {
                socket.emit('deal'); 
                return false;
            });
            $('form#fold').submit(function(event) {
                socket.emit('fold'); 
                return false;
            });
             $('form#reveal').submit(function(event) {
                socket.emit('reveal'); 
                return false;
            });
            $('form#new_game').submit(function(event) {
                socket.emit('new_game'); 
                return false;
            });
            $('form#draw_cards').submit(function(event) {
                var card1_Hld_checked = document.getElementById('card1Hld').checked;
                var card2_Hld_checked = document.getElementById('card2Hld').checked;
                var card3_Hld_checked = document.getElementById('card3Hld').checked;
                var card4_Hld_checked = document.getElementById('card4Hld').checked;
                var card5_Hld_checked = document.getElementById('card5Hld').checked;
                var card_holds = {card1: card1_Hld_checked, card2: card2_Hld_checked, 
                                  card3: card3_Hld_checked, card4: card4_Hld_checked, 
                                  card5: card5_Hld_checked}
                console.log('card_holds ', card_holds);
                socket.emit('draw_cards_draw', {data: card_holds}); 
                
                // reset the radio buttons to the default Hold checked
                document.getElementById("card1Hld").checked = true;
                document.getElementById("card2Hld").checked = true;
                document.getElementById("card3Hld").checked = true;
                document.getElementById("card4Hld").checked = true;
                document.getElementById("card5Hld").checked = true;
                
                return false;
            }); 
            // Interval function that tests message latency by sending a "ping"
            // message. The server then responds with a "pong" message and the
            // round trip time is measured. [Paul: not sure if this helps to not
            // disconnect from the server]
            var ping_pong_times = [];
            var start_time;
            window.setInterval(function() {
                start_time = (new Date).getTime();
                socket.emit('my_ping');
            }, 1000);
            
            // print to browser player draw info
             socket.on('who_drew_what', function(msg, cb) {
                // the following two lines just get the plural right in the 
                // msg displayed on the webpage
                if(msg.data == 1) var_card = "card"
                else var_card = "cards"
                $('#log').append('<br>' + $('<div/>').text(msg.player + 
                     + msg.data + ' ' + var_card).html());               
            });
            // print to browser when somebody folds
            socket.on('who_folded', function(msg, cb) {
                $('#log').append('<br>' + $('<div/>').text(msg.player ).html());               
            });

            // Handler for the "pong" message. When the pong is received, the
            // time from the ping is stored, and the average of the last 30
            // samples is average and displayed.
            socket.on('my_pong', function() {
            // bunch of code to get avg latency, and print in browers, which I 
            // don't want...            
            });
            $('form#close').submit(function(event) {
                socket.emit('close_room', {room: $('#close_room').val()});
                return false;
            });
            $('form#disconnect').submit(function(event) {
                socket.emit('disconnect_request');
                return false;
            });
        });
    </script>
  </head>
   <body>
     
     <!----------------------  New Game Button --------------------> 
     <div>  	  
     <fieldset>
        <form style='float: left; padding: 5px;' id= "new_game" class="form" method="POST" action='#'>     
           <input  class = "new_game_btn" type="submit" name="btn" value="NEW GAME" >
        </form>
        <form style='float: left; padding: 5px;' id="deal" class="form" method="POST" action='#'>
           <input  class = "deal_btn" type="submit" name="btn" value="D E A L" > 
        </form>
        <!-------------------    GAME LINKS   -------------------->
    	    &nbsp<a href="{{ url_for('redirect_to_draw') }}"  style="color:red">Draw</a>
	 </fieldset>
	 </div>
	<!-------------------    GAME LINKS   -------------------->
     
     <fieldset>
    <!---------------  Fold and Reveal buttons ---------------> 
        <form style='float: left; padding: 5px;'  id= "fold" class = "form" method="POST" action='#'> 
           <input class="submit_btn1" type="submit" name="btn" value="FOLDY-DOLDY">
        </form>
        <form style='float: left; padding: 5px;' id= "reveal" class = "form" method="POST" action='#'> 
	       <input class="submit_btn1" type="submit" name="btn" value="REVEAL">
        </form>             
    	<!---------------     JOIN button   --------------->    	
    	<form style='float: left; padding: 5px;' id="join" class="form" method="POST" action='#'>
            <input type="text" name="join_room" id="join_room" placeholder="Player Name">
            <input type="submit" value="Enter Player Name">
        </form>
      <br>
     </fieldset>   		
	  <h1 style="color:#FFDF00;">When I say "draw,"....</h1>
    <!------------------ The Poker Table ------------------->
    <hr>
    <br>	
	  <table width="500px"  height="50%">
        	<tr>
          <td></td><td></td><td></td><td></td>
          <td></td>
          <th valign=middle><h3 style="color:#FFDF00;">{{names["player1"]}}</h3></th>
          <td valign=top><img src="" id="player1_card1" width=80 height=122></td>
		  <td valign=top><img src="" id="player1_card2" width=80 height=122></td>
		  <td valign=top><img src="" id="player1_card3" width=80 height=122></td>
		  <td valign=top><img src="" id="player1_card4" width=80 height=122></td>
		  <td valign=top><img src="" id="player1_card5" width=80 height=122></td>
          <td></td><td></td><td></td><td></td>
          <td></td><td></td>
        </tr>
        <tr>
          <th valign=bottom>
              <br><br><br>
              <h3 style="color:#FFDF00;">{{names["player5"]}}</h3>
          </th>
          <td></td><td></td><td></td><td></td>
          <td></td><td></td><td></td><td></td>          
          <td></td><td></td><td></td><td></td>
          <td></td><td></td><td></td>
          <th valign=bottom>
              <h3 style="color:#FFDF00;">{{names["player2"]}}</h3>
          </th>
        </tr>
         <tr>
          <td><img src="" id="player5_card1" width=80 height=122></td>
		  <td><img src="" id="player5_card2" width=80 height=122></td>
		  <td><img src="" id="player5_card3" width=80 height=122></td>
		  <td><img src="" id="player5_card4" width=80 height=122></td>
		  <td><img src="" id="player5_card5" width=80 height=122></td>
		  <td></td>
		  <td><img src="" id="requesting_p1yr_card1" width=80 height=122></td>
          <td><img src="" id="requesting_p1yr_card2" width=80 height=122></td>
          <td><img src="" id="requesting_p1yr_card3" width=80 height=122></td>
          <td><img src="" id="requesting_p1yr_card4" width=80 height=122></td>
          <td><img src="" id="requesting_p1yr_card5" width=80 height=122></td>
		  <td></td>		  
          <td><img src="" id="player2_card1" width=80 height=122></td>
		  <td><img src="" id="player2_card2" width=80 height=122></td>
		  <td><img src="" id="player2_card3" width=80 height=122></td>
		  <td><img src="" id="player2_card4" width=80 height=122></td>
		  <td><img src="" id="player2_card5" width=80 height=122></td>
        </tr>
        <tr>
          <td></td><td></td><td></td>
          <th valign=bottom>
              <br><br><br>
              <h3 style="color:#FFDF00;">{{names["player4"]}}</h3>
          </th>          
          <td></td><td></td>
          <td valign=top>          
            <input type="radio" id="card1Hld" name="card1" value="hold" checked="checked"><label for="card1Hld" style="color:yellow;">Hold</label><br>
            <input type="radio" id="card1Dis" name="card1" value="discard"><label for="card1Dis" style="color:#DC143C; font-weight:bold;">Discard</label>           
          </td>
          <td valign=top>
            <input type="radio" id="card2Hld" name="card2" value="hold" checked="checked"><label for="card2Hld" style="color:yellow;">Hold</label><br>
            <input type="radio" id="card2Dis" name="card2" value="discard"><label for="card2Dis" style="color:#DC143C; font-weight:bold;">Discard</label>            
          </td>
          <td valign=top>
            <input type="radio" id="card3Hld" name="card3" value="hold" checked="checked"><label for="card3Hld" style="color:yellow;">Hold</label><br>
            <input type="radio" id="card3Dis" name="card3" value="discard"><label for="card3Dis" style="color:#DC143C; font-weight:bold;">Discard</label>      
            <p></p><form id="draw_cards" class="form" method="POST" action='#'>
                      <input class="submit_btn2" type="submit" name="btn" value="Draw">
                   </form>
          </td>
          <td valign=top>
            <input type="radio" id="card4Hld" name="card4" value="hold" checked="checked"><label for="card4Hld" style="color:yellow;">Hold</label><br>
            <input type="radio" id="card4Dis" name="card4" value="discard"><label for="card4Dis" style="color:#DC143C; font-weight:bold;">Discard</label>            
          </td>
          <td valign=top>
            <input type="radio" id="card5Hld" name="card5" value="hold" checked="checked"><label for="card5Hld" style="color:yellow;">Hold</label><br>
            <input type="radio" id="card5Dis" name="card5" value="discard"><label for="card5Dis" style="color:#DC143C; font-weight:bold;">Discard</label>
          
          </td><td></td><td></td>
          <th valign=bottom align="right">
              <h3 style="color:#FFDF00;">{{names["player3"]}}</h3>
          </th>
          <td></td><td></td><td></td>
        </tr>
        <tr>
          <td></td><td></td><td></td>          
          <td><img src="" id="player4_card1" width=80 height=122></td>
		  <td><img src="" id="player4_card2" width=80 height=122></td>
		  <td><img src="" id="player4_card3" width=80 height=122></td>
		  <td><img src="" id="player4_card4" width=80 height=122></td>
		  <td><img src="" id="player4_card5" width=80 height=122></td>
		  <td></td>
		  <td><img src="" id="player3_card1" width=80 height=122></td>
		  <td><img src="" id="player3_card2" width=80 height=122></td>
		  <td><img src="" id="player3_card3" width=80 height=122></td>
		  <td><img src="" id="player3_card4" width=80 height=122></td>
		  <td><img src="" id="player3_card5" width=80 height=122></td>
          <td></td><td></td><td></td>
        </tr>
	  </table> 	
	<br>	
	<div id="log"></div>
   </body>
</html>